---
title: Normal Q-Q plots - what is the robust line and should we prefer it?
author: Jeff Walker
date: '2020-10-15'
slug: normal-q-q-plots-what-is-the-robust-line-and-should-we-prefer-it
categories:
  - stats 101
tags: []
keywords:
  - tech
---



<p>Source: <a href="https://www.nature.com/articles/s41586-019-1450-6" target="_blank">Wellenstein, M.D., Coffelt, S.B., Duits, D.E., van Miltenburg, M.H., Slagter, M., de Rink, I., Henneman, L., Kas, S.M., Prekovic, S., Hau, C.S. and Vrijland, K., 2019. Loss of p53 triggers WNT-dependent systemic inflammation to drive breast cancer metastasis. Nature, 572(7770), pp.538-542.</a></p>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6707815/" target="_blank">Public source</a></p>
<p><a href="https://www.nature.com/articles/s41586-019-1450-6#Sec22" target="_blank">Data source</a></p>
<pre class="r"><code>data_from &lt;- &quot;Loss of p53 triggers WNT-dependent systemic inflammation to drive breast cancer metastasis&quot;
file_name &lt;- &quot;41586_2019_1450_MOESM3_ESM.xlsx&quot;
file_path &lt;- here(data_folder, data_from, file_name)
  
treatment_levels &lt;- c(&quot;Trp53+/+&quot;, &quot;Trp53-/-&quot;)
fig1f &lt;- read_excel(file_path,
                     sheet = &quot;Fig. 1f&quot;,
                     range = &quot;A2:B23&quot;) %&gt;%
  data.table() %&gt;%
  melt(measure.vars = treatment_levels,
       variable.name = &quot;treatment&quot;,
       value.name = &quot;il1beta&quot;)
fig1f[, treatment := factor(treatment, treatment_levels)]

# be careful of the missing data. This can create mismatch between id and residual unless specified in lm

# head(fig1f)</code></pre>
<div id="fit-a-linear-model" class="section level2">
<h2>Fit a linear model</h2>
<pre class="r"><code>m1 &lt;- lm(il1beta ~ treatment, data = fig1f)

# residuals
m1_res &lt;- residuals(m1)

# studentized residuals
sigma_m1_res &lt;- sd(m1_res) # will use this again
m1_res_st &lt;- m1_res/sigma_m1_res

n &lt;- length(m1_res)</code></pre>
</div>
<div id="q-q-plots" class="section level2">
<h2>Q-Q plots</h2>
<div id="base-r" class="section level3">
<h3>Base R</h3>
<pre class="r"><code># base R plot
qqnorm(m1_res)
qqline(m1_res)</code></pre>
<p><img src="/post/2020-10-15-normal-q-q-plots-what-is-the-robust-line-and-should-we-prefer-it_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
<div id="ggpubr" class="section level3">
<h3>ggpubr</h3>
<pre class="r"><code># ggpubr plot
ggqqplot(data = data.table(m1_res = m1_res),
         x = &quot;m1_res&quot;)</code></pre>
<p><img src="/post/2020-10-15-normal-q-q-plots-what-is-the-robust-line-and-should-we-prefer-it_files/figure-html/unnamed-chunk-5-1.png" width="672" />
### car qqPlot</p>
<pre class="r"><code># car plot

qqPlot(m1, 
       line = &quot;robust&quot;, # this is default
       simulate = FALSE,
       id = FALSE)</code></pre>
<p><img src="/post/2020-10-15-normal-q-q-plots-what-is-the-robust-line-and-should-we-prefer-it_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Q-Q plots generated by base R, <code>ggpubr::ggqqplot</code> and <code>car::qqPlot</code> are shown. The base R and <code>ggqqplot</code> functions generate the same line. <code>ggplot2::geom_qqline</code> also generates this line (not shown, but try it!). The default <code>qqPlot</code> line differs from these three. This default is <code>line = "robust"</code>. If this argument is changed to <code>line = "quartiles"</code>, the qqPlot line is the same as base R/ggqqplot. The difference between “robust” and base R/ggqqplot/“quartiles” is pretty easy to see with these data. Look at points 2-4 starting from the left. In the base R/ggqqplot, points 2 is slightly above the line, point 3 is slighty below the line, and point 4 is above the line. In the <code>qqPlot</code>, all three points are above the line. Even more striking is the confidence interval. In the ggqqplot, the upper seven (rightmost) points are well outside the interval – we would conclude that a sample from a Normal distribution would be unlikely to generate this pattern of quantiles and we should consider modeling with glm or a transformation, etc. In the qqPlot, these seven points are within or just outside the interval – we would conclude that the a sample from a Normal would result in something like these quantiles at a common enough frequency to not worry about modeling with a glm or transformation or whatever.</p>
<p>Two different interepretations, two different “decisions”. Which should decision should we decide on? I’ll return to that. But first, some sleuthing.</p>
</div>
<div id="what-are-robust-and-quartiles-lines-building-a-q-q-plot-manually" class="section level3">
<h3>What are “robust” and “quartiles” lines? Building a Q-Q plot manually</h3>
<p>Being curious what the parameters of these lines are, I went to the source – the help page for <code>qqPlot</code>. The text for the argument <code>line</code> is</p>
<blockquote>
<p>“quartiles” to pass a line through the quartile-pairs, or “robust” for a robust-regression line; the latter uses the rlm function in the MASS package.</p>
</blockquote>
<p>Okay so let’s make three lines</p>
<ol style="list-style-type: decimal">
<li>parametric – the regression line of the sample quantiles on the theoretical quantiles</li>
<li>quartiles – the regression line through the sample quartiles (the quantiles at 25% and 75%). Not sure what the intercept is. A little exploration indicated this is the median sample quartile. this is obvious in hindsight given the slope is through the quartiles.</li>
<li>robust – the regression line using <code>MASS::rlm</code>. This function has several arguments. I used the defaults.</li>
</ol>
<p>In addition to these, I used a parametric bootstrap to create my own 95% confidence band of the sample quantiles. For this, I sampled <span class="math inline">\(n\)</span> points from a standard, Normal distribution and plotted the Q-Q of this sample. I repeated this 1000 times to generate the distributions of expected sample quantiles for at each of the <span class="math inline">\(n\)</span> theoretical quantile. The 95% CI was computed as the 2.5th and 97.5th percentiles of each of these distributions.</p>
<pre class="r"><code>normal_qq &lt;- ppoints(n) %&gt;%
  qnorm()
sample_qq &lt;- m1_res[order(m1_res)]

# mean + sd
parametric_slope &lt;- sd(sample_qq)
parametric_intercept &lt;- mean(sample_qq)

# quartiles
m1_quartiles &lt;- quantile(m1_res, c(.25, .75))
qnorm_quartiles &lt;- qnorm( c(.25, .75))
m1_diff &lt;- m1_quartiles[2] - m1_quartiles[1]
qnorm_diff &lt;- qnorm_quartiles[2] - qnorm_quartiles[1] # = 1.349
quartile_slope &lt;- m1_diff/qnorm_diff
quartile_intercept &lt;- median(sample_qq)

# robust uses MASS:rlm (default arguments?)
qq_observed &lt;- data.table(normal_qq = normal_qq,
                    sample_qq = sample_qq)
m2 &lt;- rlm(sample_qq ~ normal_qq, data = qq_observed)
robust_intercept &lt;- coef(m2)[1]
robust_slope &lt;- coef(m2)[2]

# re-sample ribbon
n_iter &lt;- 1000
resample_qq &lt;- numeric(n_iter*n)
inc &lt;- 1:n
for(iter in 1:n_iter){
  y &lt;- rnorm(n, sd = sigma_m1_res)
  y_res &lt;- y - mean(y)
  resample_qq[inc] &lt;- y_res[order(y_res)]
  inc &lt;- inc + n
}

qq_sim &lt;- data.table(normal_qq = normal_qq,
                     resample_qq = resample_qq)

qq_ci &lt;- qq_sim[, .(median = median(resample_qq),
                     lower = quantile(resample_qq, 0.025),
                     upper = quantile(resample_qq, 0.975)),
                 by = normal_qq]

ggplot(data = qq_observed,
       aes(x = normal_qq, y = sample_qq)) +
  
  # ribbon
  geom_ribbon(data = qq_ci,
              aes(ymin = lower,
                  ymax = upper,
                  y = median,
                  fill = &quot;band&quot;),
              fill = &quot;gray&quot;,
              alpha = 0.6) +
  # draw points
  geom_point() +
  
  # ggplot&#39;s qq line
  geom_qq_line(aes(sample = sample_qq,
                   color = &quot;geom_qq_line&quot;),
               show.legend=TRUE,
               size = 0.75) +
  # parametric
  geom_abline(aes(intercept = parametric_intercept,
                  slope = parametric_slope,
                  color = &quot;parametric&quot;),
              show.legend=TRUE,
              size = 0.75) +
  # quartile
  geom_abline(aes(intercept = quartile_intercept,
                  slope = quartile_slope,
                  color = &quot;quartile&quot;),
              show.legend=TRUE,
              size = 0.75,
              linetype = &quot;dashed&quot;) +
  # robust
  geom_abline(aes(intercept = robust_intercept,
                  slope = robust_slope,
                  color = &quot;robust&quot;),
              show.legend = TRUE,
              size = 0.75) +
  
  
  scale_color_manual(values = pal_okabe_ito[c(1:2,5:6)]) +
  theme_minimal_grid() +
  

  
  NULL</code></pre>
<p><img src="/post/2020-10-15-normal-q-q-plots-what-is-the-robust-line-and-should-we-prefer-it_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<pre class="r"><code># geom_abline(aes(colour=&quot;best&quot;),intercept=0, slope=1, show_guide=TRUE)+</code></pre>
<p>Huh! The quartiles line, which is used by base R, ggpubr, and ggplot2, falls well outside the upper half of the 95% confidence band of sample quantiles sampled <em>from a normal distribution</em>. The parametric and robust lines slice more through the middle of the band, with the parametric nearly bisecting the band. This is a pretty good indicator that the <code>line = "robust"</code> option is preferable to the “quartiles” line used by base R/ggpubr/ggplot2.</p>
</div>
</div>
<div id="whats-going-on-in-tristan-mahrs-results" class="section level2">
<h2>What’s going on in Tristan Mahr’s results?</h2>
<p>In sleuthing out the parameters defining the lines in the different qqplot functions, in addition to the <code>qqPlot</code> help page, I discoverd Tristan Mahr’s excellent blog post <a href="https://www.tjmahr.com/quantile-quantile-plots-from-scratch/" target="_blank">Q-Q Plots and Worm Plots from Scratch</a>.</p>
<p>What confused me about Tristan’s results was the equivalence between the car::qqPlot line and a “robust” line that Tristan built by setting the robust slope to the interquartile interval divided by 1.349. This raised one minor and one major question.</p>
<p>Minor: where does the 1.349 come from? I discovered this somewhat accidentally by looking at the intermediate values in my computation. The 1.349 comes from the denominator of the slope computed by the theoretical quartiles</p>
<pre class="r"><code>qnorm_quartiles &lt;- qnorm( c(.25, .75))
(qnorm_diff &lt;- qnorm_quartiles[2] - qnorm_quartiles[1])</code></pre>
<pre><code>## [1] 1.34898</code></pre>
<p>Major: Tristan’s “robust” computation is my “quartiles” computation, which I got from the help page of <code>car::qqPlot</code>. Tristan calls the quartiles line “robust” due to this quote from John Fox, the author of qqPlot and the book <a href="https://us.sagepub.com/en-us/nam/applied-regression-analysis-and-generalized-linear-models/book237254" target="_blank">Applied Regression Analysis and Generalized Linear Models</a></p>
<blockquote>
<p>We can alternatively use the median as a robust estimator of [the mean] and the interquartile range / 1.349 as a robust estimator of [the standard deviation]. (The more conventional estimates [of the sample mean and SD] will not work well when the data are substantially non-normal.) [p. 39]</p>
</blockquote>
<p>In my example, the qqPlot default is equivalent to my line computed using robust regression (<code>MASS::rlm</code>), which I got from the qqPlot help page. In Tristan’s code, the qqPlot default is equivalent to his line computed using the sample quartiles. How could these both be TRUE?</p>
<p>The answer took a bit more sleuthing. In my qqPlot code, I used the S3 method for class ‘lm’ and passed the fit linear model from <code>lm</code>. Tristan used the default s3 method and passed the vector of samples. Curiously, the default line in qqPlot differs between these, and this is in the help page.</p>
<p>Regardless, the line computed in Tristan’s code is not the “robust” line but the “quartiles” line, despite Fox using the word “robust” in the explanation of the quartiles line.</p>
</div>
<div id="simulation" class="section level2">
<h2>Simulation</h2>
<p>I’ll work on this tomorrow.</p>
<pre class="r"><code># https://www.tjmahr.com/quantile-quantile-plots-from-scratch/
se_z &lt;- function(z, n) {
  sqrt(pnorm(z) * (1 - pnorm(z)) / n) / dnorm(z)
}</code></pre>
<pre class="r"><code>n_iter &lt;- 1000</code></pre>
</div>
